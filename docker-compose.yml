version: '3.8'

services:
  forgejo:
    build:
      context: .
      dockerfile: Dockerfile.forgejo
    container_name: forgejo
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=${FORGEJO_DB_TYPE:-sqlite3}
      - FORGEJO__database__PATH=${FORGEJO_DB_PATH:-/data/git/forgejo.db}
      - FORGEJO__server__DOMAIN=${FORGEJO_DOMAIN:-localhost}
      - FORGEJO__server__ROOT_URL=${FORGEJO_ROOT_URL:-http://localhost:5333/}
      - FORGEJO__server__SSH_DOMAIN=${FORGEJO_SSH_DOMAIN:-localhost}
      - FORGEJO__server__SSH_PORT=${FORGEJO_SSH_PORT:-5222}
      - FORGEJO__server__HTTP_PORT=3000
    volumes:
      - ${VOLUMES_BASE:-./volumes}/forgejo:/data
      - ./backups:/backups
      - ./logs:/data/log
    ports:
      - "${FORGEJO_HTTP_PORT:-5333}:3000"
      - "${FORGEJO_SSH_PORT:-5222}:22"
    networks:
      - forgejo-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 30
      start_period: 120s
      start_interval: 5s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:${WOODPECKER_VERSION:-v2.7.1-alpine}
    container_name: woodpecker-server
    restart: unless-stopped
    depends_on:
      forgejo:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - WOODPECKER_HOST=${WOODPECKER_HOST:-http://localhost:5444}
      - WOODPECKER_FORGEJO=true
      - WOODPECKER_FORGEJO_URL=${WOODPECKER_FORGEJO_URL:-http://forgejo:3000}
      - WOODPECKER_SERVER_ADDR=0.0.0.0:8000
      - WOODPECKER_FORGEJO_CLIENT=${WOODPECKER_FORGEJO_CLIENT:-}
      - WOODPECKER_FORGEJO_SECRET=${WOODPECKER_FORGEJO_SECRET:-}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_OPEN=${WOODPECKER_OPEN:-true}
      - WOODPECKER_GRPC_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_LOG_LEVEL=${WOODPECKER_LOG_LEVEL:-info}
    volumes:
      - ${VOLUMES_BASE:-./volumes}/woodpecker-server:/var/lib/woodpecker
    ports:
      - "${WOODPECKER_HTTP_PORT:-5444}:8000"
    networks:
      - forgejo-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:${WOODPECKER_VERSION:-v2.7.1-alpine}
    container_name: woodpecker-agent
    restart: unless-stopped
    depends_on:
      woodpecker-server:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_MAX_WORKFLOWS=${WOODPECKER_MAX_WORKFLOWS:-2}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - WOODPECKER_HEALTHCHECK_ADDR=:3000
    volumes:
      # ATTENTION SÉCURITÉ: Socket Docker en lecture seule (read-only)
      # Pour production, envisager Docker-in-Docker ou Podman
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${VOLUMES_BASE:-./volumes}/woodpecker-agent:/etc/woodpecker
    networks:
      - forgejo-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  forgejo-net:
    name: forgejo-net
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16