services:
  forgejo:
    build:
      context: .
      dockerfile: Dockerfile.forgejo
    container_name: forgejo
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=${FORGEJO_DB_TYPE:-sqlite3}
      - FORGEJO__database__PATH=${FORGEJO_DB_PATH:-/data/git/forgejo.db}
      - FORGEJO__server__DOMAIN=${FORGEJO_DOMAIN:-localhost}
      - FORGEJO__server__ROOT_URL=${FORGEJO_ROOT_URL:-http://localhost:5333}
      - FORGEJO__server__SSH_DOMAIN=${FORGEJO_SSH_DOMAIN:-localhost}
      - FORGEJO__server__SSH_PORT=${SSH_PORT:-5222}
      - FORGEJO__server__HTTP_PORT=3000
    volumes:
      - forgejo_data:/data
      - ./backups:/backups
      - ./logs:/data/log
    ports:
      - "${FORGEJO_HTTP_PORT:-5333}:3000"
      - "${SSH_PORT:-5222}:22"

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:next-alpine
    container_name: woodpecker-server
    restart: unless-stopped
    depends_on:
      - forgejo
    env_file:
      - .env
    environment:
      - WOODPECKER_HOST=${WOODPECKER_HOST:-http://localhost:5444}
      - WOODPECKER_GITEA=true
      - WOODPECKER_GITEA_URL=${WOODPECKER_FORGEJO_URL:-http://forgejo:3000}
    volumes:
      - woodpecker_server_data:/var/lib/woodpecker
    ports:
      - "${WOODPECKER_HTTP_PORT:-5444}:8000"

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:next-alpine
    container_name: woodpecker-agent
    restart: unless-stopped
    depends_on:
      - woodpecker-server
    env_file:
      - .env
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - woodpecker_agent_config:/etc/woodpecker

volumes:
  forgejo_data:
  woodpecker_server_data:
  woodpecker_agent_config:

networks:
  default:
    name: forgejo-net
    driver: bridge
