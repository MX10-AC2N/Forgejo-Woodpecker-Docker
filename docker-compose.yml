services:
  forgejo:
    build:
      context: .
      dockerfile: Dockerfile.forgejo
    container_name: forgejo
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=${FORGEJO_DB_TYPE:-sqlite3}
      - FORGEJO__database__PATH=${FORGEJO_DB_PATH:-/data/git/forgejo.db}
      - FORGEJO__server__DOMAIN=${FORGEJO_DOMAIN:-localhost}
      - FORGEJO__server__ROOT_URL=${FORGEJO_ROOT_URL:-http://localhost:5333/}
      - FORGEJO__server__SSH_DOMAIN=${FORGEJO_SSH_DOMAIN:-localhost}
      - FORGEJO__server__SSH_PORT=${SSH_PORT:-5222}
      - FORGEJO__server__HTTP_PORT=3000
    volumes:
      - ${VOLUMES_BASE}/forgejo:/data
      - ./backups:/backups               # ← tu peux aussi le déplacer : ${VOLUMES_BASE}/backups:/backups
      - ./logs:/data/log                 # ← idem : ${VOLUMES_BASE}/logs:/data/log
    ports:
      - "${FORGEJO_HTTP_PORT:-5333}:3000"
      - "${SSH_PORT:-5222}:22"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:next-alpine
    container_name: woodpecker-server
    restart: unless-stopped
    depends_on:
      forgejo:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - WOODPECKER_HOST=${WOODPECKER_HOST:-http://localhost:5444}
      - WOODPECKER_FORGEJO=true
      - WOODPECKER_FORGEJO_URL=http://forgejo:3000
      - WOODPECKER_FORGEJO_CLIENT=${WOODPECKER_FORGEJO_CLIENT}
      - WOODPECKER_FORGEJO_SECRET=${WOODPECKER_FORGEJO_SECRET}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_OPEN=true                  # optionnel
      - WOODPECKER_GRPC_SECRET=${WOODPECKER_AGENT_SECRET}
    volumes:
      - ${VOLUMES_BASE}/woodpecker-server:/var/lib/woodpecker
    ports:
      - "${WOODPECKER_HTTP_PORT:-5444}:8000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:next-alpine
    container_name: woodpecker-agent
    restart: unless-stopped
    depends_on:
      - woodpecker-server
    env_file:
      - .env
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_MAX_WORKFLOWS=2
      - DOCKER_HOST=unix:///var/run/docker.sock
      - WOODPECKER_HEALTHCHECK_ADDR=disabled
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${VOLUMES_BASE}/woodpecker-agent:/etc/woodpecker

# Pas de section volumes: car on utilise des bind mounts

networks:
  default:
    name: forgejo-net
    driver: bridge