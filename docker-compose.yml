services:
  forgejo:
    build:
      context: .
      dockerfile: Dockerfile.forgejo
    container_name: forgejo
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=${FORGEJO_DB_TYPE:-sqlite3}
      - FORGEJO__database__PATH=${FORGEJO_DB_PATH:-/data/git/forgejo.db}
      - FORGEJO__server__DOMAIN=${FORGEJO_DOMAIN:-localhost}
      - FORGEJO__server__ROOT_URL=${FORGEJO_ROOT_URL:-http://localhost:5333/}  # trailing / recommandé
      - FORGEJO__server__SSH_DOMAIN=${FORGEJO_SSH_DOMAIN:-localhost}
      - FORGEJO__server__SSH_PORT=${SSH_PORT:-5222}
      - FORGEJO__server__HTTP_PORT=3000
      # Optionnel : activer Actions natives si tu veux tester
      # - FORGEJO__actions__ENABLED=true
    volumes:
      - forgejo_data:/data
      - ./backups:/backups
      - ./logs:/data/log
    ports:
      - "${FORGEJO_HTTP_PORT:-5333}:3000"
      - "${SSH_PORT:-5222}:22"
    healthcheck:  # Ajout utile
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  woodpecker-server:
    image: woodpeckerci/woodpecker-server:next-alpine
    container_name: woodpecker-server
    restart: unless-stopped
    depends_on:
      forgejo:
        condition: service_healthy  # ← mieux que simple depends_on
    env_file:
      - .env
    environment:
      - WOODPECKER_HOST=${WOODPECKER_HOST:-http://localhost:5444}
      - WOODPECKER_FORGEJO=true               # ← préférable à GITEA en 2026
      - WOODPECKER_FORGEJO_URL=http://forgejo:3000
      - WOODPECKER_FORGEJO_CLIENT=${WOODPECKER_FORGEJO_CLIENT?missing}
      - WOODPECKER_FORGEJO_SECRET=${WOODPECKER_FORGEJO_SECRET?missing}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET?missing}  # Obligatoire !
      - WOODPECKER_OPEN=true                  # Optionnel : inscriptions ouvertes
      - WOODPECKER_GRPC_SECRET=${WOODPECKER_AGENT_SECRET}  # Souvent requis pour GRPC auth
      # - WOODPECKER_LOG_LEVEL=debug          # Pour debug initial
    volumes:
      - woodpecker_server_data:/var/lib/woodpecker
    ports:
      - "${WOODPECKER_HTTP_PORT:-5444}:8000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:next-alpine
    container_name: woodpecker-agent
    restart: unless-stopped
    depends_on:
      - woodpecker-server
    env_file:
      - .env
    environment:
      - WOODPECKER_SERVER=http://woodpecker-server:9000  # ← http au lieu de juste hostname:port (plus fiable)
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET?missing}
      - WOODPECKER_MAX_WORKFLOWS=2               # Ajuste selon ton CPU
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - woodpecker_agent_config:/etc/woodpecker

volumes:
  forgejo_data:
  woodpecker_server_data:
  woodpecker_agent_config:

networks:
  default:
    name: forgejo-net