name: Déploiement & Tests Forgejo + Woodpecker

on:
  workflow_dispatch:

jobs:
  test-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Afficher les versions
        run: |
          echo "Docker version:"
          docker --version
          echo "Docker Compose version:"
          docker compose version

      - name: Créer .env pour CI
        run: |
          cat << 'EOF' > .env
          FORGEJO_DOMAIN=localhost
          FORGEJO_HTTP_PORT=5333
          FORGEJO_ROOT_URL=http://localhost:5333/
          FORGEJO_SSH_PORT=5222
          FORGEJO_INTERNAL_PORT=3000
          FORGEJO_DB_TYPE=sqlite3
          FORGEJO_DB_PATH=/data/gitea/forgejo.db
          FORGEJO_MAILER_ENABLED=false
          WOODPECKER_VERSION=v2.7.1-alpine
          WOODPECKER_HOST=http://localhost:5444
          WOODPECKER_HTTP_PORT=5444
          WOODPECKER_FORGEJO=true
          WOODPECKER_FORGEJO_URL=http://forgejo:3000
          WOODPECKER_OPEN=true
          WOODPECKER_LOG_LEVEL=debug
          WOODPECKER_MAX_WORKFLOWS=2
          WOODPECKER_AGENT_SECRET=ci-test-secret-min-48-chars-DO-NOT-USE-IN-PROD-abc123def456
          ADMIN_USERNAME=forgejo-admin
          ADMIN_PASSWORD=TestPassword123!ForCIOnly
          ADMIN_EMAIL=admin@ci.local
          ADMIN_FULLNAME=CI Admin
          WOODPECKER_FORGEJO_CLIENT=
          WOODPECKER_FORGEJO_SECRET=
          VOLUMES_BASE=./volumes
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "=== .env créé ==="
          cat .env

      - name: Build la stack Docker Compose
        run: docker compose build --no-cache

      - name: Lance la stack Docker Compose
        run: docker compose up -d

      - name: Attendre Forgejo healthy (max 10 min)
        timeout-minutes: 10
        run: |
          echo "Attente Forgejo health..."
          for i in {1..120}; do
            if curl -sf http://localhost:5333/api/healthz >/dev/null 2>&1; then
              echo "Forgejo healthy après ${i} tentatives ($(($i * 5))s) !"
              curl -s http://localhost:5333/api/healthz | jq . || true
              exit 0
            fi
            echo "Tentative $i/120... (sleep 5s)"
            sleep 5
          done
          echo "Timeout Forgejo après 10 minutes"
          docker compose logs forgejo --tail 200
          exit 1

      - name: Attendre Woodpecker healthy (max 5 min)
        timeout-minutes: 5
        run: |
          echo "Attente Woodpecker health..."
          for i in {1..60}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "Woodpecker healthy après ${i} tentatives ($(($i * 5))s) !"
              exit 0
            fi
            echo "Tentative $i/60... (sleep 5s)"
            sleep 5
          done
          echo "Timeout Woodpecker après 5 minutes"
          docker compose logs woodpecker-server --tail 100
          exit 1

      # ── Attendre que first-run-init.sh termine dans Forgejo ──────────
      # On poll les logs jusqu'à voir la ligne de confirmation.
      # Timeout à 3 min : si first-run-init crashe, on le voit dans les logs.
      - name: Attendre la création OAuth dans Forgejo
        timeout-minutes: 4
        run: |
          echo "Poll des logs Forgejo pour confirmer la création OAuth..."
          for i in {1..36}; do
            # Chercher la ligne de fin émise par first-run-init.sh
            if docker compose logs forgejo 2>/dev/null | grep -q "first-run-init.sh terminé"; then
              echo "first-run-init.sh a terminé !"
              echo ""
              echo "--- Logs [INIT] complets ---"
              docker compose logs forgejo 2>/dev/null | grep "^\[INIT\]\|^WOODPECKER_FORGEJO"
              echo "--- fin ---"
              exit 0
            fi
            echo "Attente... ($(($i * 5))s)"
            sleep 5
          done
          echo ""
          echo "Timeout : first-run-init.sh n'a pas confirmé après 3 min."
          echo "--- Tous les logs Forgejo (pour débrider) ---"
          docker compose logs forgejo --tail 100 2>/dev/null || true
          echo "--- fin ---"
          exit 1

      # ── Extraire les credentials et recréer Woodpecker avec OAuth ────
      - - name: Configurer OAuth dans Woodpecker
        run: |
          echo "=== Extraction des credentials OAuth depuis les logs ==="
          # Extraire CLIENT et SECRET des logs Forgejo
          OAUTH_CLIENT=$(docker compose logs forgejo 2>/dev/null | grep "^WOODPECKER_FORGEJO_CLIENT=" | tail -n1 | cut -d= -f2 | tr -d '\r\n')
          OAUTH_SECRET=$(docker compose logs forgejo 2>/dev/null | grep "^WOODPECKER_FORGEJO_SECRET=" | tail -n1 | cut -d= -f2 | tr -d '\r\n')

          echo "Client ID extrait : ${OAUTH_CLIENT:0:24}..."
          echo "Secret extrait    : ${OAUTH_SECRET:0:24}..."

          if [ -z "$OAUTH_CLIENT" ] || [ -z "$OAUTH_SECRET" ]; then
            echo "ERREUR : credentials vides après extraction"
            docker compose logs forgejo 2>/dev/null | grep -i "oauth\|INIT\|ERREUR" || true
            exit 1
          fi

          # Mettre à jour le .env
          sed -i "s|^WOODPECKER_FORGEJO_CLIENT=.*|WOODPECKER_FORGEJO_CLIENT=$OAUTH_CLIENT|" .env
          sed -i "s|^WOODPECKER_FORGEJO_SECRET=.*|WOODPECKER_FORGEJO_SECRET=$OAUTH_SECRET|" .env

          echo "=== .env mis à jour ==="
          grep "WOODPECKER_FORGEJO" .env

          # Recréer Woodpecker Server avec les credentials OAuth
          echo "=== Recréation de Woodpecker Server avec OAuth ==="
          docker compose up -d --force-recreate woodpecker-server

          # Attendre qu'il soit healthy
          echo "Attente Woodpecker Server health..."
          for i in {1..30}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "✅ Woodpecker healthy avec OAuth !"
              exit 0
            fi
            echo "Tentative $i/30... (sleep 2s)"
            sleep 2
          done
          echo "❌ Timeout Woodpecker après recréation"
          docker compose logs woodpecker-server --tail 50
          exit 1

          # Attendre qu'il soit healthy à nouveau
          echo "Attente Woodpecker healthy après recréation..."
          for i in {1..24}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "Woodpecker healthy avec OAuth !"
              exit 0
            fi
            echo "Attente health ($i/24)..."
            sleep 5
          done
          echo "ERREUR : Woodpecker pas healthy après recréation"
          docker compose logs woodpecker-server --tail 50 || true
          exit 1

      # ── Tests de base ─────────────────────────────────────────────────
      - name: Tests de base
        run: |
          echo "=== Test 1: Forgejo health ==="
          curl -sf http://localhost:5333/api/healthz | jq . || exit 1

          echo ""
          echo "=== Test 2: Woodpecker health ==="
          curl -sf http://localhost:5444/healthz >/dev/null && echo "OK" || exit 1

          echo ""
          echo "=== Test 3: Woodpecker UI ==="
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5444)
          echo "Code HTTP UI: $HTTP_CODE"
          [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || { echo "Code inattendu"; exit 1; }
          echo "OK"

      # ── Test OAuth : la vérification qui compte ──────────────────────
      # On fait un GET (pas HEAD) sur /authorize et on capture la Location.
      # Si OAuth est configuré → 302/303 vers Forgejo /oauth/authorize
      # Si OAuth n'est pas configuré → 200 (page login Woodpecker) ou redirect interne
      - name: Vérifier OAuth Forgejo ↔ Woodpecker
        run: |
          echo "=== Test OAuth : redirection vers Forgejo ==="

          # GET sur /authorize, on capture les headers de la réponse initiale (sans suivre)
          HEADERS=$(curl -s -D - -o /dev/null http://localhost:5444/authorize)
          echo "--- Headers réponse ---"
          echo "$HEADERS"
          echo "--- fin headers ---"

          HTTP_CODE=$(echo "$HEADERS" | head -1 | grep -oP '\d{3}')
          LOCATION=$(echo "$HEADERS" | grep -i "^location:" | sed 's/[Ll]ocation: *//' | tr -d '\r')

          echo ""
          echo "HTTP code : $HTTP_CODE"
          echo "Location  : $LOCATION"
          echo ""

          # Valider
          if [ -n "$LOCATION" ] && echo "$LOCATION" | grep -q "forgejo"; then
            echo "OAuth configuré correctement : redirection vers Forgejo"
            echo "URL de redirection : $LOCATION"
          elif [ -n "$LOCATION" ] && echo "$LOCATION" | grep -q "localhost:3000"; then
            echo "OAuth configuré correctement : redirection vers Forgejo (localhost:3000)"
            echo "URL de redirection : $LOCATION"
          else
            echo "ERREUR : pas de redirection vers Forgejo"
            echo "  HTTP code : $HTTP_CODE"
            echo "  Location  : $LOCATION"
            echo ""
            echo "--- Logs Woodpecker (50 dernières lignes) ---"
            docker compose logs woodpecker-server --tail 50 || true
            echo "--- Env du conteneur woodpecker-server ---"
            docker inspect woodpecker-server --format '{{range $key, $value := .Config.Env}}{{$key}}={{$value}}{{"\n"}}{{end}}' 2>/dev/null | grep -i "forgejo\|oauth\|CLIENT\|SECRET" || true
            exit 1
          fi

          echo ""
          echo "=== Vérification côté Forgejo : OAuth app existe ? ==="
          # On vérifie via l'API Forgejo que l'application OAuth "Woodpecker CI" existe bien
          ADMIN_TOKEN=$(docker compose logs forgejo 2>/dev/null | grep "Token response" | tail -1 | grep -oP '"sha1"\s*:\s*"\K[^"]+')
          if [ -n "$ADMIN_TOKEN" ]; then
            APPS=$(curl -s -H "Authorization: token $ADMIN_TOKEN" \
              http://localhost:5333/api/v1/users/admin/applications/oauth2)
            echo "Applications OAuth dans Forgejo :"
            echo "$APPS" | jq '.[].name' 2>/dev/null || echo "$APPS"
          else
            echo "Token non trouvé dans les logs pour vérifier côté Forgejo (non bloquant)"
          fi

      # ── Structure des volumes ─────────────────────────────────────────
      - name: Vérifier structure des volumes
        run: |
          echo "=== Structure des volumes ==="
          ls -la volumes/ || true
          ls -la volumes/forgejo/ || true
          ls -la volumes/woodpecker-server/ || true
          ls -la volumes/woodpecker-agent/ || true

      # ── Backups et logs ───────────────────────────────────────────────
      - name: Vérifier les backups et logs
        run: |
          echo "=== Répertoires backups et logs ==="
          ls -la backups/ || echo "Pas encore de backups (normal)"
          ls -la logs/ || echo "Pas encore de logs (normal)"
          echo ""
          echo "=== Log d'initialisation ==="
          cat logs/forgejo-init.log || echo "Fichier non trouvé"

      # ── Backup manuel ─────────────────────────────────────────────────
      - name: Test backup manuel
        run: |
          echo "=== Test création backup manuel ==="
          docker compose exec -T -u git forgejo /scripts/backup.sh || echo "Backup échoué (peut être normal si DB pas encore prête)"
          echo ""
          echo "Backups créés :"
          ls -lh backups/ || true

      # ── Logs détaillés en cas d'échec ─────────────────────────────────
      - name: Logs détaillés en cas d'échec
        if: failure()
        run: |
          echo "=========================================="
          echo "=== LOGS FORGEJO ==="
          echo "=========================================="
          docker compose logs forgejo --tail 200 || true

          echo ""
          echo "=========================================="
          echo "=== LOGS WOODPECKER-SERVER ==="
          echo "=========================================="
          docker compose logs woodpecker-server --tail 200 || true

          echo ""
          echo "=========================================="
          echo "=== LOGS WOODPECKER-AGENT ==="
          echo "=========================================="
          docker compose logs woodpecker-agent --tail 100 || true

          echo ""
          echo "=========================================="
          echo "=== ÉTAT DES CONTENEURS ==="
          echo "=========================================="
          docker compose ps -a

          echo ""
          echo "=========================================="
          echo "=== ENV woodpecker-server (filtré) ==="
          echo "=========================================="
          docker inspect woodpecker-server --format '{{range $key, $value := .Config.Env}}{{$key}}={{$value}}{{"\n"}}{{end}}' 2>/dev/null | grep -i "forgejo\|oauth\|client\|secret\|open" || true

          echo ""
          echo "=========================================="
          echo "=== FICHIER .env (secrets masqués) ==="
          echo "=========================================="
          cat .env | sed 's/\(SECRET\|PASSWORD\)=.*/\1=***/' || true

      # ── Cleanup ───────────────────────────────────────────────────────
      - name: Cleanup
        if: always()
        run: |
          echo "=== Nettoyage ==="
          docker compose down -v
          echo "Stack arrêtée et volumes supprimés"
