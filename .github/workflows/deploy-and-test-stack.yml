name: D√©ploiement & Tests Forgejo + Woodpecker

on:
  workflow_dispatch:
  
jobs:
  test-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Afficher les versions
        run: |
          echo "Docker version:"
          docker --version
          echo "Docker Compose version:"
          docker compose version

      - name: Cr√©er .env pour CI
        run: |
          cat << 'EOF' > .env
          # Configuration CI/CD optimis√©e
          FORGEJO_DOMAIN=localhost
          FORGEJO_HTTP_PORT=5333
          FORGEJO_ROOT_URL=http://localhost:5333/
          FORGEJO_SSH_PORT=5222
          FORGEJO_INTERNAL_PORT=3000
          FORGEJO_DB_TYPE=sqlite3
          FORGEJO_DB_PATH=/data/git/forgejo.db
          FORGEJO_MAILER_ENABLED=false
          
          WOODPECKER_VERSION=v2.7.1-alpine
          WOODPECKER_HOST=http://localhost:5444
          WOODPECKER_HTTP_PORT=5444
          WOODPECKER_FORGEJO=true
          WOODPECKER_FORGEJO_URL=http://forgejo:3000
          WOODPECKER_OPEN=true
          WOODPECKER_LOG_LEVEL=debug
          WOODPECKER_MAX_WORKFLOWS=2
          
          # Secrets pour tests uniquement (JAMAIS en production)
          WOODPECKER_AGENT_SECRET=ci-test-secret-min-48-chars-DO-NOT-USE-IN-PROD-abc123def456
          
          # Admin auto-cr√©√© par first-run-init.sh
          ADMIN_USERNAME=admin
          ADMIN_PASSWORD=TestPassword123!ForCIOnly
          ADMIN_EMAIL=admin@ci.local
          ADMIN_FULLNAME=CI Admin
          
          # OAuth sera auto-configur√© par le script
          WOODPECKER_FORGEJO_CLIENT=
          WOODPECKER_FORGEJO_SECRET=
          
          # Volumes locaux pour CI
          VOLUMES_BASE=./volumes
          EOF
          
          echo "=== Configuration .env cr√©√©e ==="
          cat .env

      - name: Build la stack Docker Compose
        run: docker compose build --no-cache

      - name: Lance la stack Docker Compose
        run: docker compose up -d

      - name: Attendre Forgejo healthy (max 10 min)
        timeout-minutes: 10
        run: |
          echo "‚è≥ Attente Forgejo health (max 10 min)..."
          for i in {1..120}; do
            if curl -sf http://localhost:5333/api/healthz >/dev/null 2>&1; then
              echo "‚úÖ Forgejo healthy apr√®s ${i} tentatives ($(($i * 5))s) !"
              curl -s http://localhost:5333/api/healthz | jq . || true
              exit 0
            fi
            echo "Tentative $i/120... (sleep 5s)"
            sleep 5
          done
          echo "‚ùå Timeout Forgejo apr√®s 10 minutes"
          docker compose logs forgejo --tail 200
          exit 1

      - name: Attendre Woodpecker healthy (max 5 min)
        timeout-minutes: 5
        run: |
          echo "‚è≥ Attente Woodpecker health..."
          for i in {1..60}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "‚úÖ Woodpecker healthy apr√®s ${i} tentatives ($(($i * 5))s) !"
              exit 0
            fi
            echo "Tentative $i/60... (sleep 5s)"
            sleep 5
          done
          echo "‚ùå Timeout Woodpecker apr√®s 5 minutes"
          docker compose logs woodpecker-server --tail 100
          exit 1

      - name: üîë Configuration OAuth automatique
        run: |
          echo "============================================================="
          echo "  Configuration OAuth Forgejo ‚Üí Woodpecker"
          echo "============================================================="
          
          # Attendre que l'initialisation soit compl√®te
          echo "‚è≥ Attente de la g√©n√©ration OAuth (30s)..."
          sleep 30
          
          # Extraire les credentials des logs
          echo "üîç Extraction des credentials OAuth..."
          OAUTH_CLIENT=$(docker compose logs forgejo 2>/dev/null | grep "WOODPECKER_FORGEJO_CLIENT=" | tail -n1 | sed 's/.*WOODPECKER_FORGEJO_CLIENT=//' | tr -d '\r\n')
          OAUTH_SECRET=$(docker compose logs forgejo 2>/dev/null | grep "WOODPECKER_FORGEJO_SECRET=" | tail -n1 | sed 's/.*WOODPECKER_FORGEJO_SECRET=//' | tr -d '\r\n')
          
          if [ -n "$OAUTH_CLIENT" ] && [ -n "$OAUTH_SECRET" ]; then
            echo "‚úÖ Credentials OAuth trouv√©s !"
            echo "   Client ID: ${OAUTH_CLIENT:0:20}..."
            echo "   Secret: ${OAUTH_SECRET:0:20}..."
            
            # Ajouter au .env
            echo "" >> .env
            echo "# OAuth auto-configur√© par CI" >> .env
            echo "WOODPECKER_FORGEJO_CLIENT=$OAUTH_CLIENT" >> .env
            echo "WOODPECKER_FORGEJO_SECRET=$OAUTH_SECRET" >> .env
            
            echo "üìù Credentials ajout√©s √† .env"
            
            # Red√©marrer Woodpecker avec les nouveaux credentials
            echo "üîÑ Red√©marrage de Woodpecker Server..."
            docker compose restart woodpecker-server
            
            # Attendre que Woodpecker red√©marre
            echo "‚è≥ Attente red√©marrage Woodpecker (30s)..."
            sleep 30
            
            # V√©rifier que Woodpecker est √† nouveau healthy
            for i in {1..20}; do
              if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
                echo "‚úÖ Woodpecker red√©marr√© avec OAuth configur√© !"
                break
              fi
              echo "Attente health apr√®s restart ($i/20)..."
              sleep 3
            done
            
            echo "============================================================="
          else
            echo "‚ö†Ô∏è OAuth credentials non trouv√©s dans les logs"
            echo "   Ceci est normal si l'application OAuth existait d√©j√†"
            echo "   La configuration OAuth sera test√©e quand m√™me"
            echo "============================================================="
          fi

      - name: Tests de base
        run: |
          echo "=== Test 1: Forgejo health ==="
          curl -sf http://localhost:5333/api/healthz || exit 1
          echo "‚úÖ OK"
          
          echo ""
          echo "=== Test 2: Woodpecker health ==="
          curl -sf http://localhost:5444/healthz || exit 1
          echo "‚úÖ OK"
          
          echo ""
          echo "=== Test 3: Woodpecker UI ==="
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:5444)
          echo "Code HTTP UI: $HTTP_CODE"
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ]; then
            echo "‚úÖ OK"
          else
            echo "‚ùå Code inattendu: $HTTP_CODE"
            exit 1
          fi
          
          echo ""
          echo "=== Test 4: OAuth redirect endpoint ==="
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:5444/authorize)
          echo "Code HTTP /authorize: $HTTP_CODE"
          
          # 302/303 = redirection vers Forgejo (OAuth configur√©)
          # 401 = non autoris√© mais endpoint existe
          # 200 = page de login
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || [ "$HTTP_CODE" -eq 303 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "‚úÖ OAuth endpoint r√©pond correctement (code $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Code inattendu: $HTTP_CODE"
          fi

      - name: Test OAuth flow complet
        run: |
          echo "=== Test du flux OAuth complet ==="
          
          # Suivre la redirection
          REDIRECT_URL=$(curl -sI http://localhost:5444/authorize | grep -i "^location:" | cut -d' ' -f2 | tr -d '\r')
          
          if [ -n "$REDIRECT_URL" ]; then
            echo "‚úÖ Redirection OAuth d√©tect√©e vers: $REDIRECT_URL"
            
            if echo "$REDIRECT_URL" | grep -q "forgejo"; then
              echo "‚úÖ OAuth correctement configur√© (redirection vers Forgejo)"
            else
              echo "‚ö†Ô∏è Redirection inattendue: $REDIRECT_URL"
            fi
          else
            echo "‚ÑπÔ∏è Pas de redirection OAuth (peut √™tre normal selon la configuration)"
          fi

      - name: V√©rifier OAuth dans les logs Woodpecker
        run: |
          echo "=== V√©rification configuration OAuth dans Woodpecker ==="
          docker compose logs woodpecker-server | tail -n 100 | grep -i "forgejo" || echo "Pas d'erreur OAuth d√©tect√©e"

      - name: V√©rifier structure des volumes
        run: |
          echo "=== Structure des volumes ==="
          ls -la volumes/ || true
          ls -la volumes/forgejo/ || true
          ls -la volumes/woodpecker-server/ || true
          ls -la volumes/woodpecker-agent/ || true

      - name: V√©rifier les backups et logs
        run: |
          echo "=== R√©pertoires backups et logs ==="
          ls -la backups/ || echo "Pas encore de backups (normal)"
          ls -la logs/ || echo "Pas encore de logs (normal)"
          
          echo ""
          echo "=== Contenu du log d'initialisation ==="
          cat logs/forgejo-init.log || echo "Fichier non trouv√©"

      - name: Test backup manuel
        run: |
          echo "=== Test cr√©ation backup manuel ==="
          # Lancer en tant que user git, pas root
          docker compose exec -T -u git forgejo /scripts/backup.sh || echo "‚ö†Ô∏è Backup √©chou√© (peut √™tre normal si DB pas encore pr√™te)"
          echo ""
          echo "Backups cr√©√©s :"
          ls -lh backups/ || true

      - name: Logs d√©taill√©s en cas d'√©chec
        if: failure()
        run: |
          echo "=========================================="
          echo "=== LOGS FORGEJO (200 derni√®res lignes) ==="
          echo "=========================================="
          docker compose logs forgejo --tail 200 || true
          
          echo ""
          echo "=========================================="
          echo "=== LOGS WOODPECKER-SERVER ==="
          echo "=========================================="
          docker compose logs woodpecker-server --tail 200 || true
          
          echo ""
          echo "=========================================="
          echo "=== LOGS WOODPECKER-AGENT ==="
          echo "=========================================="
          docker compose logs woodpecker-agent --tail 200 || true
          
          echo ""
          echo "=========================================="
          echo "=== √âTAT DES CONTENEURS ==="
          echo "=========================================="
          docker compose ps -a
          
          echo ""
          echo "=========================================="
          echo "=== SANT√â DES CONTENEURS ==="
          echo "=========================================="
          docker inspect forgejo --format='{{.State.Health.Status}}' || true
          docker inspect woodpecker-server --format='{{.State.Health.Status}}' || true
          docker inspect woodpecker-agent --format='{{.State.Health.Status}}' || true
          
          echo ""
          echo "=========================================="
          echo "=== FICHIER .env (secrets masqu√©s) ==="
          echo "=========================================="
          cat .env | grep -v "SECRET\|PASSWORD" || true

      - name: Cleanup
        if: always()
        run: |
          echo "=== Nettoyage ==="
          docker compose down -v
          echo "‚úÖ Stack arr√™t√©e et volumes supprim√©s"