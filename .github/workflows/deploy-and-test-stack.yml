name: D√©ploiement & Tests Forgejo + Woodpecker

on:
  workflow_dispatch:

jobs:
  test-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Afficher les versions
        run: |
          echo "Docker version:"
          docker --version
          echo "Docker Compose version:"
          docker compose version

      - name: Cr√©er .env pour CI
        run: |
          cat << 'EOF' > .env
          FORGEJO_DOMAIN=localhost
          FORGEJO_HTTP_PORT=5333
          FORGEJO_ROOT_URL=http://localhost:5333/
          FORGEJO_SSH_PORT=5222
          FORGEJO_INTERNAL_PORT=3000
          FORGEJO_DB_TYPE=sqlite3
          FORGEJO_DB_PATH=/data/gitea/forgejo.db
          FORGEJO_MAILER_ENABLED=false
          WOODPECKER_VERSION=v2.7.1-alpine
          WOODPECKER_HOST=http://localhost:5444
          WOODPECKER_HTTP_PORT=5444
          WOODPECKER_FORGEJO=true
          WOODPECKER_FORGEJO_URL=http://forgejo:3000
          WOODPECKER_OPEN=true
          WOODPECKER_LOG_LEVEL=debug
          WOODPECKER_MAX_WORKFLOWS=2
          WOODPECKER_AGENT_SECRET=ci-test-secret-min-48-chars-DO-NOT-USE-IN-PROD-abc123def456
          ADMIN_USERNAME=forgejo-admin
          ADMIN_PASSWORD=TestPassword123!ForCIOnly
          ADMIN_EMAIL=admin@ci.local
          ADMIN_FULLNAME=CI Admin
          WOODPECKER_FORGEJO_CLIENT=
          WOODPECKER_FORGEJO_SECRET=
          VOLUMES_BASE=./volumes
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "=== .env cr√©√© ==="
          cat .env

      - name: Build la stack Docker Compose
        run: docker compose build --no-cache

      - name: Lance la stack Docker Compose
        run: docker compose up -d

      - name: Attendre Forgejo healthy (max 10 min)
        timeout-minutes: 10
        run: |
          echo "Attente Forgejo health..."
          for i in {1..120}; do
            if curl -sf http://localhost:5333/api/healthz >/dev/null 2>&1; then
              echo "‚úÖ Forgejo healthy apr√®s ${i} tentatives ($(($i * 5))s) !"
              curl -s http://localhost:5333/api/healthz | jq . || true
              exit 0
            fi
            echo "Tentative $i/120... (sleep 5s)"
            sleep 5
          done
          echo "‚ùå Timeout Forgejo apr√®s 10 minutes"
          docker compose logs forgejo --tail 200
          exit 1

      - name: Attendre Woodpecker healthy (max 5 min)
        timeout-minutes: 5
        run: |
          echo "Attente Woodpecker health..."
          for i in {1..60}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "‚úÖ Woodpecker healthy apr√®s ${i} tentatives ($(($i * 5))s) !"
              exit 0
            fi
            echo "Tentative $i/60... (sleep 5s)"
            sleep 5
          done
          echo "‚ùå Timeout Woodpecker apr√®s 5 minutes"
          docker compose logs woodpecker-server --tail 100
          exit 1

      - name: Attendre la cr√©ation OAuth dans Forgejo
        timeout-minutes: 4
        run: |
          echo "üîç Poll des logs Forgejo pour confirmer la cr√©ation OAuth..."
          for i in {1..36}; do
            # CORRECTION: Pattern grep corrig√© pour matcher les logs Docker Compose
            if docker compose logs forgejo 2>/dev/null | grep -q "first-run-init.sh termin√©"; then
              echo "‚úÖ first-run-init.sh a termin√© !"
              echo ""
              echo "--- Logs [INIT] et OAuth complets ---"
              # CORRECTION: Pattern sans ^ pour matcher apr√®s le pr√©fixe "forgejo  | "
              docker compose logs forgejo 2>/dev/null | grep "\[INIT\]\|WOODPECKER_FORGEJO_CLIENT\|WOODPECKER_FORGEJO_SECRET" | tail -20
              echo "--- fin ---"
              exit 0
            fi
            echo "Attente... ($(($i * 5))s)"
            sleep 5
          done
          echo ""
          echo "‚ùå Timeout : first-run-init.sh n'a pas confirm√© apr√®s 3 min."
          echo "--- Tous les logs Forgejo (debug) ---"
          docker compose logs forgejo --tail 100 2>/dev/null || true
          echo "--- fin ---"
          exit 1

      - name: Configurer OAuth dans Woodpecker
        run: |
          echo "=== üîê Extraction des credentials OAuth depuis les logs ==="
          
          # AM√âLIORATION: Extraction plus robuste avec validation
          OAUTH_CLIENT=$(docker compose logs forgejo 2>/dev/null | grep "^forgejo.*WOODPECKER_FORGEJO_CLIENT=" | tail -n1 | sed 's/.*WOODPECKER_FORGEJO_CLIENT=//' | tr -d '\r\n' | xargs)
          OAUTH_SECRET=$(docker compose logs forgejo 2>/dev/null | grep "^forgejo.*WOODPECKER_FORGEJO_SECRET=" | tail -n1 | sed 's/.*WOODPECKER_FORGEJO_SECRET=//' | tr -d '\r\n' | xargs)

          echo "Client ID extrait : ${OAUTH_CLIENT:0:36}"
          echo "Secret extrait    : ${OAUTH_SECRET:0:24}..."

          # Validation des credentials
          if [ -z "$OAUTH_CLIENT" ] || [ -z "$OAUTH_SECRET" ]; then
            echo "‚ùå ERREUR : credentials vides apr√®s extraction"
            echo ""
            echo "Logs d'initialisation complets :"
            docker compose logs forgejo 2>/dev/null | grep -i "oauth\|INIT\|ERREUR" || true
            exit 1
          fi

          # Validation format UUID pour CLIENT_ID
          if ! echo "$OAUTH_CLIENT" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'; then
            echo "‚ö†Ô∏è  ATTENTION : Le Client ID ne semble pas √™tre un UUID valide"
            echo "Valeur: $OAUTH_CLIENT"
          fi

          # Mettre √† jour le .env
          echo ""
          echo "=== üìù Mise √† jour du fichier .env ==="
          sed -i "s|^WOODPECKER_FORGEJO_CLIENT=.*|WOODPECKER_FORGEJO_CLIENT=$OAUTH_CLIENT|" .env
          sed -i "s|^WOODPECKER_FORGEJO_SECRET=.*|WOODPECKER_FORGEJO_SECRET=$OAUTH_SECRET|" .env

          echo "‚úÖ .env mis √† jour :"
          grep "WOODPECKER_FORGEJO_CLIENT\|WOODPECKER_FORGEJO_SECRET" .env

          # Recr√©er Woodpecker Server avec les credentials OAuth
          echo ""
          echo "=== üîÑ Recr√©ation de Woodpecker Server avec OAuth ==="
          docker compose up -d --force-recreate woodpecker-server

          # Attendre qu'il soit healthy
          echo "Attente Woodpecker Server health..."
          for i in {1..30}; do
            if curl -sf http://localhost:5444/healthz >/dev/null 2>&1; then
              echo "‚úÖ Woodpecker healthy avec OAuth configur√© !"
              
              # V√©rifier que les variables sont bien charg√©es
              echo ""
              echo "=== V√©rification des variables d'environnement dans le conteneur ==="
              docker compose exec -T woodpecker-server env | grep "WOODPECKER_FORGEJO" || echo "‚ö†Ô∏è  Variables non trouv√©es"
              
              exit 0
            fi
            echo "Tentative $i/30... (sleep 2s)"
            sleep 2
          done
          echo "‚ùå Timeout Woodpecker apr√®s recr√©ation"
          docker compose logs woodpecker-server --tail 50
          exit 1

      - name: Tests de validation
        run: |
          echo "=== üß™ Tests de validation de la stack ==="
          echo ""
          
          echo "Test 1/5: Forgejo health"
          if curl -sf http://localhost:5333/api/healthz >/dev/null; then
            echo "  ‚úÖ Forgejo OK"
          else
            echo "  ‚ùå Forgejo health check failed"
            exit 1
          fi

          echo ""
          echo "Test 2/5: Woodpecker health"
          if curl -sf http://localhost:5444/healthz >/dev/null; then
            echo "  ‚úÖ Woodpecker OK"
          else
            echo "  ‚ùå Woodpecker health check failed"
            exit 1
          fi

          echo ""
          echo "Test 3/5: Woodpecker UI"
          if curl -sf http://localhost:5444 | grep -q "Woodpecker"; then
            echo "  ‚úÖ UI Woodpecker OK"
          else
            echo "  ‚ùå UI Woodpecker ne r√©pond pas correctement"
            exit 1
          fi

          echo ""
          echo "Test 4/5: OAuth endpoint (/authorize)"
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:5444/authorize)
          echo "  Code HTTP /authorize : $HTTP_CODE"
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || [ "$HTTP_CODE" -eq 401 ]; then
            echo "  ‚úÖ OAuth redirect OK (code valide: $HTTP_CODE)"
          else
            echo "  ‚ùå OAuth redirect failed (code inattendu: $HTTP_CODE)"
            exit 1
          fi

          echo ""
          echo "Test 5/5: Variables OAuth dans Woodpecker"
          CLIENT_IN_CONTAINER=$(docker compose exec -T woodpecker-server env | grep "^WOODPECKER_FORGEJO_CLIENT=" | cut -d= -f2)
          SECRET_IN_CONTAINER=$(docker compose exec -T woodpecker-server env | grep "^WOODPECKER_FORGEJO_SECRET=" | cut -d= -f2)
          
          if [ -n "$CLIENT_IN_CONTAINER" ] && [ -n "$SECRET_IN_CONTAINER" ]; then
            echo "  ‚úÖ Variables OAuth pr√©sentes dans le conteneur"
            echo "     CLIENT: ${CLIENT_IN_CONTAINER:0:36}"
            echo "     SECRET: ${SECRET_IN_CONTAINER:0:24}..."
          else
            echo "  ‚ùå Variables OAuth manquantes ou vides dans le conteneur"
            echo "     CLIENT: $CLIENT_IN_CONTAINER"
            echo "     SECRET: $SECRET_IN_CONTAINER"
            exit 1
          fi

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ TOUS LES TESTS SONT PASS√âS AVEC SUCC√àS !"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Logs d√©taill√©s (si √©chec)
        if: failure()
        run: |
          echo "=========================================="
          echo "=== üîç LOGS FORGEJO ==="
          echo "=========================================="
          docker compose logs forgejo --tail 200 || true
          echo ""
          echo "=========================================="
          echo "=== üîç LOGS WOODPECKER-SERVER ==="
          echo "=========================================="
          docker compose logs woodpecker-server --tail 200 || true
          echo ""
          echo "=========================================="
          echo "=== üîç LOGS WOODPECKER-AGENT ==="
          echo "=========================================="
          docker compose logs woodpecker-agent --tail 200 || true
          echo ""
          echo "=========================================="
          echo "=== üìä √âTAT DES CONTENEURS ==="
          echo "=========================================="
          docker compose ps
          echo ""
          echo "=========================================="
          echo "=== üîê ENV woodpecker-server (filtr√©) ==="
          echo "=========================================="
          docker compose exec -T woodpecker-server env | grep -E "WOODPECKER|FORGEJO|ADMIN" | sort || true
          echo ""
          echo "=========================================="
          echo "=== üìÑ FICHIER .env (secrets masqu√©s) ==="
          echo "=========================================="
          cat .env | sed 's/\(PASSWORD\|SECRET\)=.*/\1=***/g'
          echo ""
          echo "=========================================="
          echo "=== üìÅ CONTENU VOLUME /shared ==="
          echo "=========================================="
          docker compose exec -T forgejo ls -lah /shared/ || true
          docker compose exec -T forgejo cat /shared/oauth-credentials.env 2>/dev/null || echo "Fichier oauth-credentials.env non trouv√©"

      - name: Nettoyage
        if: always()
        run: |
          echo "=== üßπ Nettoyage ==="
          docker compose down -v
          echo "‚úÖ Stack arr√™t√©e et volumes supprim√©s"
