name: Déploiement & Tests Forgejo + Woodpecker

on:
  workflow_dispatch:

jobs:
  test-stack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copier .env.example en .env
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "Aucun .env.example trouvé → création minimal"
          fi

      - name: Créer .env minimal pour CI
        run: |
          cat << EOF > .env
          FORGEJO_DOMAIN=localhost
          FORGEJO_HTTP_PORT=5333
          FORGEJO_ROOT_URL=http://localhost:5333/
          FORGEJO_SSH_PORT=5222
          FORGEJO_INTERNAL_PORT=3000
          FORGEJO_MAILER_ENABLED=false
          WOODPECKER_HOST=http://localhost:5444
          WOODPECKER_HTTP_PORT=5444
          WOODPECKER_FORGEJO=true
          WOODPECKER_FORGEJO_URL=http://forgejo:3000
          WOODPECKER_AGENT_SECRET=testsecret12345678901234567890abcdef
          EOF

      - name: Build la stack Docker Compose
        run: docker compose build --no-cache

      - name: Lance la stack Docker Compose
        run: docker compose up -d

      - name: Attendre Forgejo healthy (tolérance haute pour CI)
        timeout-minutes: 10   # ← monte à 10 min
        run: |
          echo "Attente Forgejo health (max 10 min)..."
          for i in {1..120}; do
            if curl -sf http://localhost:5333/api/healthz; then
              echo "Forgejo healthy !"
              curl -s http://localhost:5333/api/healthz | jq .
              exit 0
            fi
            echo "Tentative $i/120..."
            sleep 5
          done
          echo "Timeout Forgejo"
          docker compose logs forgejo --tail 200
          exit 1

      - name: Attendre Woodpecker healthy
        timeout-minutes: 5
        run: |
          echo "Attente Woodpecker health..."
          for i in {1..60}; do
            if curl -sf http://localhost:5444/healthz; then
              echo "Woodpecker healthy !"
              exit 0
            fi
            echo "Tentative $i/60..."
            sleep 5
          done
          echo "Timeout Woodpecker"
          docker compose logs woodpecker-server --tail 100
          exit 1

      - name: Tests de base
        run: |
          echo "Test Forgejo health"
          curl -sf http://localhost:5333/api/healthz || exit 1

          echo "Test Woodpecker health"
          curl -sf http://localhost:5444/healthz || exit 1

          echo "Test Woodpecker UI"
          curl -sf http://localhost:5444 | grep -q "<title>Woodpecker</title>" || exit 1

          echo "Test page authorize (OAuth redirect)"
          HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" http://localhost:5444/authorize)
          echo "Code HTTP /authorize : $HTTP_CODE"
          [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 302 ] || [ "$HTTP_CODE" -eq 401 ] || exit 1

      - name: Logs détaillés en cas d'échec
        if: always()
        run: |
          echo "=== LOGS FORGEJO ==="
          docker compose logs forgejo --tail 200 || true
          echo ""
          echo "=== LOGS WOODPECKER-SERVER ==="
          docker compose logs woodpecker-server --tail 200 || true
          echo ""
          echo "=== LOGS WOODPECKER-AGENT ==="
          docker compose logs woodpecker-agent --tail 200 || true

      - name: Cleanup
        if: always()
        run: docker compose down -v